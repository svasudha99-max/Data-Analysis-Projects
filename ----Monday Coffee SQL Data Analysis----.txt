----Monday Coffee Data Analysis----
SELECT * FROM city;
SELECT * FROM products;
SELECT * FROM customers;
SELECT * FROM sales;

----Reports and Data Analysis----

---1) Coffee Consumers Count
---How many people in each city are estimated to consume coffee, given that 25% of the population does?
SELECT
city_name,
ROUND((population * 0.25)/1000000,2) as coffee_consumers_in_millions,
city_rank
FROM city
ORDER BY 2 DESC

---Total Revenue from Coffee Sales
---What is the total revenue generated from coffee sales across all cities in the last quarter of 2023?

SELECT 
SUM(total) as total_revenue
FROM sales
WHERE
EXTRACT(YEAR FROM sale_date) = 2023
AND
EXTRACT(QUARTER FROM sale_date) = 4

SELECT 
ci.city_name,
SUM(s.total) as total_revenue
FROM sales as s
JOIN customers as c
ON s.customer_id = c.customer_id
JOIN city as ci
ON ci.city_id = c.city_id 
WHERE
EXTRACT(YEAR FROM s.sale_date) = 2023
AND
EXTRACT(QUARTER FROM s.sale_date) = 4
GROUP BY 1
ORDER BY 2 DESC


----Sales Count for Each Product
----How many units of each coffee product have been sold?

SELECT 
p.product_name, 
COUNT(s.sale_id) as total_orders
FROM products as p
LEFT JOIN 
sales as s 
ON s.product_id = p.product_id
GROUP BY 1
ORDER BY 2 DESC

---Average Sales Amount per City
---What is the average sales amount per customer in each city?

---city and total sales
---no of customers in each city

SELECT 
ci.city_name,
SUM(s.total) as total_revenue,
COUNT(DISTINCT s.customer_id) as total_customers,
ROUND(SUM(s.total::numeric)/COUNT(DISTINCT s.customer_id::numeric),2) as avr_sale_per_cx
FROM sales as s
JOIN customers as c
ON s.customer_id = c.customer_id
JOIN city as ci
ON ci.city_id = c.city_id 
GROUP BY 1
ORDER BY 2 DESC

---City Population and Coffee Consumers
---Provide a list of cities along with their populations and estimated coffee consumers
WITH city_table as 
(
SELECT
city_name,
ROUND((population * 0.25)/1000000 , 2) as coffee_consumers
FROM city
),
customers_table
AS
(
SELECT
ci.city_name,
COUNT(DISTINCT c.customer_id) as unique_cx
FROM sales as s
JOIN customers as c
ON c.customer_id = s.customer_id
JOIN city as ci
ON ci.city_id = c.city_id
GROUP BY 1
)
SELECT
customers_table.city_name,
city_table.coffee_consumers as coffee_consumers_in_millions,
customers_table.unique_cx
FROM city_table 
JOIN
customers_table 
ON city_table.city_name = customers_table.city_name

---Top selling products by city
---What are the top 3 selling products in each city based on sales volume?
SELECT *
FROM 
(
SELECT 
ci.city_name,
p.product_name,
COUNT(s.sale_id) as total_orders,
DENSE_RANK() OVER(PARTITION BY ci.city_name ORDER BY COUNT(s.sale_id) DESC) as rank
FROM sales as s
JOIN products as p
ON s.product_id = p.product_id
JOIN customers as c
ON c.customer_id = s.customer_id
JOIN city as ci
ON ci.city_id = c.city_id
GROUP BY 1,2
)as t1
WHERE rank <= 3

---Customer Segmentation by City
---How many unique customers are there in each city who have purchased coffee products?
SELECT * FROM products;

SELECT 
ci.city_name,
COUNT(DISTINCT c.customer_id) as unique_cx
FROM city as ci
LEFT JOIN
customers as c
ON c.city_id = ci.city_id
JOIN sales as s
ON s.customer_id = c.customer_id
WHERE 
s.product_id IN (1,2,3,4,5,6,7,8,9,10,11,12,13,14)
GROUP BY 1

---Average sale vs rent
---Find each city and their average sale per customer 
WITH city_table
AS
(
SELECT 
ci.city_name,
COUNT(DISTINCT s.customer_id) as total_customers,
ROUND(SUM(s.total::numeric)/COUNT(DISTINCT s.customer_id::numeric),2) as avr_sale_per_cx
FROM sales as s
JOIN customers as c
ON s.customer_id = c.customer_id
JOIN city as ci
ON ci.city_id = c.city_id 
GROUP BY 1
ORDER BY 2 DESC
),
city_rent 
AS
( 
SELECT city_name,estimated_rent 
FROM city)

SELECT cr.city_name, cr.estimated_rent, ct.total_customers, ct.avr_sale_per_cx,
ROUND(cr.estimated_rent::numeric/ct.total_customers::numeric, 2) as avr_rent_per_cx
FROM city_rent as cr
JOIN city_table as ct
ON cr.city_name = ct.city_name


---city and total rent/total cx 
